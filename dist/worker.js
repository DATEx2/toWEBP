(()=>{var H=(p,s)=>()=>(s||p((s={exports:{}}).exports,s),s.exports);var L=H(()=>{self.onmessage=async function(p){let{id:s,file:f,quality:b}=p.data;try{if(f.type==="image/svg+xml")throw new Error("SVG detected - requesting main thread conversion");let t=await createImageBitmap(f),w=Math.min(480,t.height),U=w/t.height,F=t.width*U,M=new OffscreenCanvas(F,w);M.getContext("2d").drawImage(t,0,0,F,w);let P=await M.convertToBlob({type:"image/webp",quality:.65}),u=new FileReader,R=await new Promise(o=>{u.onloadend=()=>o(u.result),u.readAsDataURL(P)});self.postMessage({type:"thumb",id:s,thumbnail:R});let a=new OffscreenCanvas(t.width,t.height);a.getContext("2d").drawImage(t,0,0);let r=p.data.format||"image/webp";if(r==="image/gif")try{typeof GifWriter>"u"&&importScripts("https://cdn.jsdelivr.net/npm/omggif@1.0.10/omggif.min.js");let n=a.getContext("2d").getImageData(0,0,a.width,a.height).data,{width:g,height:m}=a,y=new Map,T=Math.max(1,Math.floor(g*m/1e4));for(let e=0;e<n.length;e+=4*T){if(n[e+3]<128)continue;let i=n[e]<<16|n[e+1]<<8|n[e+2];y.set(i,(y.get(i)||0)+1)}let z=Math.max(2,Math.floor(b*256)),c=[...y.entries()].sort((e,i)=>i[1]-e[1]).slice(0,z).map(e=>e[0]);for(;c.length<256;)c.push(0);let B=new Uint8Array(g*m),I=new Map;for(let e=0;e<n.length;e+=4){let i=n[e],x=n[e+1],v=n[e+2],q=i<<16|x<<8|v,d=I.get(q);if(d===void 0){let A=1/0;for(let l=0;l<z;l++){let E=c[l]>>16&255,G=c[l]>>8&255,O=c[l]&255,C=(i-E)*(i-E)+(x-G)*(x-G)+(v-O)*(v-O);if(C<A&&(A=C,d=l),C===0)break}I.set(q,d)}B[e/4]=d}let W=new Uint8Array(g*m*2+1024),D=new GifWriter(W,g,m,{loop:0});D.addFrame(0,0,g,m,B,{palette:c});let j=new Blob([W.subarray(0,D.end())],{type:"image/gif"});t.close(),self.postMessage({type:"result",id:s,success:!0,blob:j,originalSize:f.size,newSize:j.size});return}catch(o){console.warn("GIF Worker Error, falling back to basic:",o)}let k={type:r};(r==="image/jpeg"||r==="image/webp"||r==="image/avif")&&(k.quality=b);let h=await a.convertToBlob(k);if(r==="image/webp"&&h.type!=="image/webp")try{typeof libwebp>"u"&&importScripts("https://cdn.jsdelivr.net/npm/webp-converters-browser@1.0.3/dist/webp-converters-browser.min.js");let S=a.getContext("2d").getImageData(0,0,a.width,a.height),n=await WebpConverter.encode(S.data,a.width,a.height,b*100);h=new Blob([n],{type:"image/webp"})}catch(o){console.warn("WASM WebP Fallback failed:",o)}t.close(),self.postMessage({type:"result",id:s,success:!0,blob:h,originalSize:f.size,newSize:h.size})}catch(t){console.debug("Worker conversion skipped/failed, requesting fallback:",t.message),self.postMessage({type:"fallback",id:s,error:t.toString()})}}});L();})();
